name: Cleanup Backup Files

on:
  pull_request:
    types: [closed]
    branches: [main, master]

env:
  PYTHON_VERSION: '3.9'

jobs:
  cleanup-backups:
    # Only run if PR was merged (not just closed) AND it's not a cleanup PR itself
    if: |
      github.event.pull_request.merged == true &&
      !startsWith(github.event.pull_request.head.ref, 'cleanup_backups_')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.ref }}
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config --global user.name 'Salt State Converter Bot'
        git config --global user.email 'salt-converter@github-actions.bot'
    
    - name: Create Cleanup Branch
      id: branch
      run: |
        # Generate branch name
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        BRANCH_NAME="cleanup_backups_${TIMESTAMP}"
        
        echo "Creating cleanup branch: $BRANCH_NAME"
        git checkout -b "$BRANCH_NAME"
        
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
    
    - name: Find and Remove Backup Files
      id: cleanup
      run: |
        # Find all .backup files
        echo "Searching for backup files..."
        BACKUP_FILES=$(find . -type f -name "*.backup" 2>/dev/null || true)
        
        if [ -z "$BACKUP_FILES" ]; then
          echo "No backup files found."
          echo "backup_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Count backup files
        BACKUP_COUNT=$(echo "$BACKUP_FILES" | wc -l)
        echo "Found $BACKUP_COUNT backup file(s):"
        echo "$BACKUP_FILES"
        
        # Remove backup files
        echo "$BACKUP_FILES" | while read -r file; do
          if [ -n "$file" ] && [ -f "$file" ]; then
            echo "Deleting: $file"
            rm "$file"
          fi
        done
        
        echo "backup_count=$BACKUP_COUNT" >> $GITHUB_OUTPUT
    
    - name: Commit Cleanup
      if: steps.cleanup.outputs.backup_count > 0
      id: commit
      run: |
        # Check if there are changes to commit
        if git diff --quiet && git diff --cached --quiet; then
          echo "No changes to commit (backup files may have already been removed)"
          echo "committed=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Stage deleted files
        git add -A
        
        BACKUP_COUNT="${{ steps.cleanup.outputs.backup_count }}"
        
        cat > /tmp/commit_msg << EOF
        Cleanup: Remove backup files after Salt state conversion
        
        Automatically removed ${BACKUP_COUNT} backup file(s) created during 
        Salt state conversion process.
        
        PR: #${{ github.event.pull_request.number }}
        Merged by: @${{ github.event.pull_request.merged_by.login }}
        
        Generated by Cleanup Backup Files GitHub Action
        EOF
        
        # Commit the changes
        git commit -F /tmp/commit_msg
        
        COMMIT_HASH=$(git rev-parse HEAD)
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
        echo "committed=true" >> $GITHUB_OUTPUT
        
        echo "âœ… Changes committed: $COMMIT_HASH"
    
    - name: Push Cleanup Branch and Create PR
      if: steps.commit.outputs.committed == 'true'
      run: |
        BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
        BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
        
        echo "Pushing cleanup branch: $BRANCH_NAME"
        git push origin "$BRANCH_NAME"
        echo "âœ… Successfully pushed cleanup branch"
        
        # Create PR body
        cat > /tmp/pr_body << 'EOF'
        ## ðŸ§¹ Automatic Backup File Cleanup
        
        This PR automatically removes backup files that were created during the Salt state conversion process.
        
        **Triggered by:** Merge of PR #${{ github.event.pull_request.number }}
        **Merged by:** @${{ github.event.pull_request.merged_by.login }}
        
        ### Files to be Removed
        This PR will delete **${{ steps.cleanup.outputs.backup_count }}** backup file(s) with the `.backup` extension.
        
        ### Why?
        Backup files are created during Salt state conversion to preserve the original files. Once the conversion has been reviewed and merged, these backup files are no longer needed and can be safely removed.
        
        ### Action Required
        Please review the changes to ensure only `.backup` files are being removed, then merge this PR to complete the cleanup.
        
        ---
        *Generated by Cleanup Backup Files GitHub Action*
        EOF
        
        # Create pull request without labels (labels may not exist)
        echo "Creating pull request..."
        gh pr create \
          --title "ðŸ§¹ Cleanup: Remove backup files from PR #${{ github.event.pull_request.number }}" \
          --body-file /tmp/pr_body \
          --head "$BRANCH_NAME" \
          --base "$BASE_BRANCH"
        
        PR_NUMBER=$(gh pr view "$BRANCH_NAME" --json number -q .number)
        PR_URL=$(gh pr view "$BRANCH_NAME" --json url -q .url)
        
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
        echo "âœ… Pull request created: $PR_URL"
        
        # Try to add labels if they exist (optional, won't fail if labels don't exist)
        echo "Attempting to add labels..."
        gh pr edit "$PR_NUMBER" --add-label "automated" 2>/dev/null || echo "Note: 'automated' label not found, skipping"
        gh pr edit "$PR_NUMBER" --add-label "cleanup" 2>/dev/null || echo "Note: 'cleanup' label not found, skipping"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Add Comment to Original PR
      if: steps.commit.outputs.committed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const backupCount = ${{ steps.cleanup.outputs.backup_count }};
          const branchName = '${{ steps.branch.outputs.branch_name }}';
          
          const comment = `## ðŸ§¹ Backup Files Cleanup
          
          A cleanup PR has been created to remove **${backupCount}** backup file(s) created during the Salt state conversion.
          
          **Next Steps:**
          1. Review the cleanup PR to verify only \`.backup\` files are being removed
          2. Merge the cleanup PR to complete the process
          
          The backup files were created during the Salt state conversion process and are no longer needed after your changes have been merged.
          
          ðŸ”— **Cleanup PR:** Search for PRs with branch \`${branchName}\` or check your notifications.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Create Cleanup Summary
      if: steps.cleanup.outputs.backup_count > 0
      run: |
        echo "## ðŸ§¹ Backup Files Cleanup Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Original PR:** #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
        echo "**Merged by:** @${{ github.event.pull_request.merged_by.login }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Results:**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—‘ï¸ Backup files found: ${{ steps.cleanup.outputs.backup_count }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.commit.outputs.committed }}" == "true" ]; then
          echo "- âœ… Cleanup branch: \`${{ steps.branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ï¿½ Pull request created for review" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ Target branch: \`${{ github.event.pull_request.base.ref }}\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the cleanup pull request" >> $GITHUB_STEP_SUMMARY
        echo "2. Verify only \`.backup\` files are being removed" >> $GITHUB_STEP_SUMMARY
        echo "3. Merge the cleanup PR to complete the process" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Backup files are automatically created during Salt state conversion to preserve original files. Once the conversion is merged, these backups are no longer needed." >> $GITHUB_STEP_SUMMARY
